<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Perfil | Mi Galer√≠a</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script type="module" src="config.js"></script>
</head>
<body>
  <header>
    <div class="logo">üì∏ Mi Galer√≠a</div>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="login.html" id="loginLink">Login</a></li>
        <li><a href="profile.html" id="profileLink">Mi perfil</a></li>
      </ul>
    </nav>
  </header>

  <main class="profile-container">
    <h1>üë§ Perfil</h1>

    <!-- Perfil info -->
    <div class="profile-info">
      <img id="profileAvatar" src="" alt="Avatar" class="avatar">
      <h2 id="profileName">Nombre</h2>
      <p id="profileEmail">Email</p>
      <p id="profileBio">Biograf√≠a</p>
    </div>

    <!-- Formulario de edici√≥n SOLO para due√±o -->
    <div id="editSection" style="display:none;">
      <h3>‚úèÔ∏è Editar perfil</h3>
      <form id="editForm">
        <label>Nombre:
          <input type="text" id="editName">
        </label>
        <label>Biograf√≠a:
          <textarea id="editBio"></textarea>
        </label>
        <label>Foto de perfil:
          <input type="file" id="editAvatar" accept="image/*">
        </label>
        <button type="submit">Guardar cambios</button>
      </form>
      <div id="msgBox"></div>
    </div>

    <!-- Galer√≠a -->
    <h3>üì∑ Mis im√°genes</h3>
    <div id="gallery" class="gallery-grid"></div>
  </main>

  <footer>
    <p>¬© 2025 Mi Galer√≠a</p>
  </footer>

  <script type="module">
    import { supabase } from "./config.js";

    document.addEventListener("DOMContentLoaded", async () => {
      // 1. Usuario autenticado
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      // ¬øSe visita otro perfil? Ej: profile.html?id=xxxx
      const params = new URLSearchParams(window.location.search);
      const profileId = params.get("id") || user.id; // si no hay id, mostrar el m√≠o

      // 2. Cargar perfil
      const { data: profile, error } = await supabase
        .from("usuarios")
        .select("*")
        .eq("id", profileId)
        .single();

      if (error) {
        console.error("‚ùå Error cargando perfil:", error.message);
        return;
      }

      // Pintar perfil
      document.getElementById("profileEmail").textContent = profile.email;
      document.getElementById("profileName").textContent = profile.name || "Sin nombre";
      document.getElementById("profileBio").textContent = profile.bio || "Sin biograf√≠a";
      if (profile.avatar_url) {
        document.getElementById("profileAvatar").src = profile.avatar_url;
      } else {
        document.getElementById("profileAvatar").src = "default-avatar.png";
      }

      // 3. Mostrar edici√≥n solo si es mi perfil
      if (profileId === user.id) {
        document.getElementById("editSection").style.display = "block";
        document.getElementById("editName").value = profile.name || "";
        document.getElementById("editBio").value = profile.bio || "";
      }

      // 4. Guardar cambios
      const form = document.getElementById("editForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("editName").value.trim();
        const bio = document.getElementById("editBio").value.trim();
        const file = document.getElementById("editAvatar").files[0];

        let avatarUrl = profile.avatar_url;

        // subir nueva imagen si hay
        if (file) {
          const filePath = `${user.id}/${Date.now()}-${file.name}`;
          const { error: uploadError } = await supabase.storage
            .from("avatars")
            .upload(filePath, file, { upsert: true });
          if (uploadError) {
            alert("Error subiendo imagen: " + uploadError.message);
            return;
          }
          const { data: publicUrl } = supabase.storage
            .from("avatars")
            .getPublicUrl(filePath);
          avatarUrl = publicUrl.publicUrl;
        }

        // actualizar perfil
        const { error: updateError } = await supabase
          .from("usuarios")
          .update({ name, bio, avatar_url: avatarUrl })
          .eq("id", user.id);

        if (updateError) {
          document.getElementById("msgBox").textContent = "‚ùå Error guardando cambios";
        } else {
          document.getElementById("msgBox").textContent = "‚úÖ Cambios guardados";
          location.reload();
        }
      });

      // 5. Galer√≠a de im√°genes
      const { data: images, error: galleryError } = await supabase
        .from("imagenes")
        .select("*")
        .eq("user_id", profileId)
        .order("created_at", { ascending: false });

      if (galleryError) {
        console.error("‚ùå Error cargando galer√≠a:", galleryError.message);
      } else {
        const galleryDiv = document.getElementById("gallery");
        if (images.length === 0) {
          galleryDiv.innerHTML = "<p>Sin im√°genes todav√≠a.</p>";
        } else {
          images.forEach(img => {
            const el = document.createElement("img");
            el.src = img.url;
            el.alt = img.titulo || "foto";
            el.classList.add("gallery-item");
            galleryDiv.appendChild(el);
          });
        }
      }
    });
  </script>
</body>
</html>
